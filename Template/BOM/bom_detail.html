{% extends "bootstrap/vertical_base.html" %}
{% load humanize %}

{% load custom_filters %}

{% load static %}

{% block title %}{{ bom.name }}{% endblock %}

{% block extra_css %}
<!-- Select2 css -->
<link href="{% static 'css/vendor/select2.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Daterangepicker css -->
<link href="{% static 'css/vendor/daterangepicker.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Touchspin css -->
<link href="{% static 'css/vendor/jquery.bootstrap-touchspin.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Flatpickr Timepicker css -->
<link href="{% static 'css/vendor/flatpickr.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Datepicker css -->
<link href="{% static 'css/vendor/bootstrap-datepicker.min.css' %}" rel="stylesheet" type="text/css" />
<!-- Bootstrap Timepicker css -->
<link href="{% static 'css/vendor/bootstrap-timepicker.min.css' %}" rel="stylesheet" type="text/css" />

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

<link href="{% static 'css/inputs.css' %}" rel="stylesheet" type="text/css" >

<!-- Selectize.js CSS -->
<link href="{% static 'css/selectize.min.css' %}" rel="stylesheet" type="text/css" >
<link href="{% static 'css/form_builder.css' %}" rel="stylesheet" type="text/css" >

<style>
    .bom-tree {
        list-style-type: none;
        padding-left: 1rem;
    }
    .bom-tree li {
        position: relative;
        padding-left: 1.5rem;
    }
    .bom-tree li:before {
        content: "";
        position: absolute;
        left: 0;
        top: 0.75rem;
        width: 1rem;
        height: 1px;
        background-color: #dee2e6;
    }
    .bom-tree li:after {
        content: "";
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 1px;
        background-color: #dee2e6;
    }
    .bom-tree li:last-child:after {
        height: 0.75rem;
    }
    .component-item:hover {
        background-color: rgba(13, 110, 253, 0.1);
        cursor: pointer;
    }
    .component-item.active {
        background-color: rgba(13, 110, 253, 0.2);
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-3">
    <div class="col">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/bom/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'bom_list' %}">BOMs</a></li>
                <li class="breadcrumb-item active" aria-current="page">{{ bom.name }}</li>
            </ol>
        </nav>
    </div>
    <div class="col-auto mt-2">
        <div class="dropdown">
            <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="bomActionsDropdown" data-bs-toggle="dropdown">
                <i class="bi bi-gear"></i> Actions
            </button>
            <ul class="dropdown-menu dropdown-menu-end">
                <li><a class="dropdown-item" href="#"><i class="bi bi-file-earmark-pdf"></i> Export PDF</a></li>
                <li><a class="dropdown-item" href="#"><i class="bi bi-file-excel"></i> Export Excel</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'bom_compare' pk=bom.id %}"><i class="bi bi-file-diff"></i> Compare Versions</a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="{% url 'bom_update' pk=bom.id %}"><i class="bi bi-pencil"></i> Edit BOM</a></li>
                {% if bom.status == 'DR' %}
                    <li><button class="dropdown-item" id="requestApprovalBtn"><i class="bi bi-check-circle"></i> Request Approval</button></li>
                {% endif %}
            </ul>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col">
        <h2>
            <i class="bi bi-list-ul"></i> {{ bom.name }}
            <small class="text-muted">Rev {{ bom.revision }}</small>
            <small><span style="font-size:12px;"class="badge
                {% if bom.status == 'AC' %}bg-success
                {% elif bom.status == 'DR' %}bg-secondary
                {% elif bom.status == 'PE' %}bg-warning text-dark
                {% else %}bg-dark{% endif %}">
                {{ bom.get_status_display }}
            </span></small>
            
        </h2>
        
        <p class="lead">{{ bom.description }}</p>
    </div>
    <div class="col-auto">
        <div class="d-flex gap-2">
            <button class="btn btn-primary" id="saveBomBtn">
                <i class="bi bi-save"></i> Save
            </button>
            <button class="btn btn-outline-secondary">
                <i class="bi bi-printer"></i> Print
            </button>
        </div>
    </div>
</div>

<div class="row">
    <!-- Left Column - Tree View -->
    <div class="col-md-4">
        <div class="card mb-3">
            <div class="card-header ">
                <i class="bi bi-diagram-3"></i> BOM Structure
            </div>
            <div class="card-body" style="max-height: 500px; overflow-y: auto;">
                <ul class="bom-tree">
                    {% for item in bom.items.all %}
                        <li class="mb-2">
                            <div class="component-item d-flex justify-content-between align-items-center p-2 rounded" 
                                 data-item-id="{{ item.id }}"
                                 data-component-id="{{ item.component.id }}">
                                <div>
                                    <strong>{{ item.component.part_number }}</strong>
                                    <small class="d-block">{{ item.component.description|truncatechars:30 }}</small>
                                    <small class="text-muted">Qty: {{ item.quantity }}</small>
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger remove-item-btn" data-item-id="{{ item.id }}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </li>
                    {% empty %}
                        <div class="alert alert-info">No components added to this BOM yet.</div>
                    {% endfor %}
                </ul>
                
                <button class="btn btn-sm btn-outline-primary mt-3 w-100" data-bs-toggle="modal" data-bs-target="#addComponentModal">
                    <i class="bi bi-plus-circle"></i> Add Component
                </button>
            </div>
        </div>
        
        <!-- Comments Section -->
        <div class="card">
            <div class="card-header ">
                <i class="bi bi-chat-left-text"></i> Comments
            </div>
            <div class="card-body" style="max-height: 300px; overflow-y: auto;">
                {% for comment in bom.comments.all %}
                    <div class="mb-3">
                        <div class="d-flex justify-content-between">
                            <strong>{{ comment.author.get_full_name }}</strong>
                            <small class="text-muted">{{ comment.created_date|timesince }} ago</small>
                        </div>
                        <p class="mb-0">{{ comment.text }}</p>
                    </div>
                    {% if not forloop.last %}<hr>{% endif %}
                {% empty %}
                    <p class="text-muted">No comments yet.</p>
                {% endfor %}
                
                <hr>
                <form method="post" action="{% url 'add_comment' %}">
                    {% csrf_token %}
                    {{ comment_form.as_p }}
                    <button type="submit" class="btn btn-primary btn-sm">Post Comment</button>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Right Column - Properties and Tabs -->
    <div class="col-md-8">
        <div class="card mb-3">
            <div class="card-header ">
                <i class="bi bi-info-circle"></i> Properties
                <span id="propertiesTitle" class="float-end"></span>
            </div>
            <div class="card-body" id="propertiesPanel">
                <div class="text-center text-muted py-5">
                    <i class="bi bi-box-seam" style="font-size: 3rem;"></i>
                    <p class="mt-3">Select a component to view details</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header ">
                <ul class="nav nav-tabs card-header-tabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#componentsTab">
                            <i class="bi bi-list-ul"></i> Components
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#docsTab">
                            <i class="bi bi-file-earmark"></i> Documentation
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#historyTab">
                            <i class="bi bi-clock-history"></i> History
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#whereUsedTab">
                            <i class="bi bi-diagram-3"></i> Where Used
                        </a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <!-- Components Tab -->
                    <div class="tab-pane fade show active" id="componentsTab">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Part No.</th>
                                        <th>Description</th>
                                        <th>Qty</th>
                                        <th>Ref Des</th>
                                        <th>Unit Cost</th>
                                        <th>Total Cost</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in bom.items.all %}
                                        <tr data-item-id="{{ item.id }}" class="component-row">
                                            <td>{{ item.component.part_number }}</td>
                                            <td>{{ item.component.description|truncatechars:50 }}</td>
                                            <td>{{ item.quantity }}</td>
                                            <td>{{ item.reference_designators|default:"-" }}</td>
                                            <td>${{ item.component.suppliers.first.cost|default:"0.00"|floatformat:2 }}</td>
                                            <td>${{ item.extended_cost|floatformat:2 }}</td>
                                            <td>
                                                <button class="btn btn-sm btn-outline-primary edit-item-btn" data-item-id="{{ item.id }}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    {% empty %}
                                        <tr>
                                            <td colspan="7" class="text-center">No components added to this BOM yet.</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-active">
                                        <td colspan="5" class="text-end"><strong>Total:</strong></td>
                                        <td><strong>${{ bom.total_cost|floatformat:2 }}</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Documentation Tab -->
                    <div class="tab-pane fade" id="docsTab">
                        {% if bom.documents.all %}
                            <div class="list-group">
                                {% for doc in bom.documents.all %}
                                    <a href="{{ doc.file.url }}" class="list-group-item list-group-item-action" target="_blank">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">{{ doc.name }}</h6>
                                            <small>{{ doc.get_document_type_display }}</small>
                                        </div>
                                        <p class="mb-1">{{ doc.description|truncatechars:80 }}</p>
                                        <small>Uploaded by {{ doc.uploaded_by.get_full_name }} on {{ doc.uploaded_date|date:"SHORT_DATE_FORMAT" }}</small>
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">No documents attached to this BOM.</div>
                        {% endif %}
                        
                        <hr>
                        <h5>Upload New Document</h5>
                        <form method="post" enctype="multipart/form-data">
                            {% csrf_token %}
                            {{ document_form.as_p }}
                            <button type="submit" class="btn btn-primary">Upload</button>
                        </form>
                    </div>
                    
                    <!-- History Tab -->
                    <div class="tab-pane fade" id="historyTab">
                        {% if bom.revisions.all %}
                            <div class="list-group">
                                {% for rev in bom.revisions.all %}
                                    <div class="list-group-item">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">Revision {{ rev.revision }}</h6>
                                            <small>{{ rev.created_date|timesince }} ago</small>
                                        </div>
                                        <p class="mb-1">{{ rev.change_reason }}</p>
                                        <small>Created by {{ rev.created_by.get_full_name }}</small>
                                        <div class="mt-2">
                                            <a href="{% url 'bom_compare' pk=bom.id %}?rev1={{ rev.id }}" class="btn btn-sm btn-outline-primary">
                                                Compare
                                            </a>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">No revision history for this BOM.</div>
                        {% endif %}
                    </div>
                    
                    <!-- Where Used Tab -->
                    <div class="tab-pane fade" id="whereUsedTab">
                        {% if bom.child_boms.all %}
                            <div class="list-group">
                                {% for child in bom.child_boms.all %}
                                    <a href="{% url 'bom_detail' pk=child.id %}" class="list-group-item list-group-item-action">
                                        <div class="d-flex w-100 justify-content-between">
                                            <h6 class="mb-1">{{ child.name }}</h6>
                                            <span class="badge 
                                                {% if child.status == 'AC' %}bg-success
                                                {% elif child.status == 'DR' %}bg-secondary
                                                {% elif child.status == 'PE' %}bg-warning text-dark
                                                {% else %}bg-dark{% endif %}">
                                                {{ child.get_status_display }}
                                            </span>
                                        </div>
                                        <p class="mb-1">{{ child.description|truncatechars:80 }}</p>
                                        <small>Rev {{ child.revision }} | Created by {{ child.created_by.get_full_name }}</small>
                                    </a>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div class="alert alert-info">This BOM is not used in any other assemblies.</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Component Modal -->
<div class="modal fade" id="addComponentModal" tabindex="-1" aria-labelledby="addComponentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addComponentModalLabel">Add Component to BOM</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addComponentForm">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label for="componentSearch" class="form-label">Search Components</label>
                        <input type="text" class="form-control" id="componentSearch" placeholder="Type to search...">
                        <div id="searchResults" class="mt-2" style="max-height: 200px; overflow-y: auto; display: none;">
                            <div class="list-group" id="componentResultsList"></div>
                        </div>
                    </div>
                    
                    <div id="selectedComponentInfo" class="mb-3 p-3 bg-light rounded" style="display: none;">
                        <h6 id="selectedComponentName"></h6>
                        <p class="mb-1" id="selectedComponentDesc"></p>
                        <small class="text-muted" id="selectedComponentCategory"></small>
                    </div>
                    
                    <input type="hidden" id="selectedComponentId" name="component">
                    <input type="hidden" name="bom" value="{{ bom.id }}">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="quantity" class="form-label">Quantity</label>
                                <input type="number" step="0.01" min="0.01" class="form-control" id="quantity" name="quantity" value="1" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="reference_designators" class="form-label">Reference Designators</label>
                                <input type="text" class="form-control" id="reference_designators" name="reference_designators" placeholder="A1, B2, C3...">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="notes" class="form-label">Notes</label>
                        <textarea class="form-control" id="notes" name="notes" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmAddComponent">Add to BOM</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Item Modal -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editItemModalLabel">Edit BOM Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editItemForm">
                    {% csrf_token %}
                    <input type="hidden" id="editItemId" name="item_id">
                    
                    <div class="mb-3">
                        <label for="editQuantity" class="form-label">Quantity</label>
                        <input type="number" step="0.01" min="0.01" class="form-control" id="editQuantity" name="quantity" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editReferenceDesignators" class="form-label">Reference Designators</label>
                        <input type="text" class="form-control" id="editReferenceDesignators" name="reference_designators">
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNotes" class="form-label">Notes</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmEditItem">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Request Approval Modal -->
<div class="modal fade" id="requestApprovalModal" tabindex="-1" aria-labelledby="requestApprovalModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requestApprovalModalLabel">Request BOM Approval</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="approvalRequestForm">
                    {% csrf_token %}
                    <input type="hidden" name="bom_id" value="{{ bom.id }}">
                    
                    <div class="mb-3">
                        <label for="approvalComments" class="form-label">Comments</label>
                        <textarea class="form-control" id="approvalComments" name="comments" rows="3" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmRequestApproval">Submit Request</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Component search functionality
    $('#componentSearch').on('input', function() {
        const query = $(this).val();
        if (query.length < 2) {
            $('#searchResults').hide();
            return;
        }
        
        // Filter from the preloaded components
        const filtered = window.allComponents.filter(comp => 
            comp.part_number.toLowerCase().includes(query.toLowerCase()) || 
            comp.description.toLowerCase().includes(query.toLowerCase())
        );
        
        const resultsList = $('#componentResultsList');
        resultsList.empty();
        
        if (filtered.length > 0) {
            filtered.forEach(comp => {
                resultsList.append(`
                    <a href="#" class="list-group-item list-group-item-action component-result" 
                       data-id="${comp.id}" 
                       data-part="${comp.part_number}" 
                       data-desc="${comp.description}" 
                       data-category="${comp.category}">
                        <strong>${comp.part_number}</strong> - ${comp.description}
                    </a>
                `);
            });
            $('#searchResults').show();
        } else {
            resultsList.append('<div class="list-group-item">No components found</div>');
            $('#searchResults').show();
        }
    });
    
    // Component selection
    $(document).on('click', '.component-result', function(e) {
        e.preventDefault();
        const id = $(this).data('id');
        const part = $(this).data('part');
        const desc = $(this).data('desc');
        const category = $(this).data('category');
        
        $('#selectedComponentId').val(id);
        $('#selectedComponentName').text(part);
        $('#selectedComponentDesc').text(desc);
        $('#selectedComponentCategory').text('Category: ' + category);
        $('#selectedComponentInfo').show();
    });
    
    // Add component to BOM
    $('#confirmAddComponent').click(function() {
        const form = $('#addComponentForm');
        $.ajax({
            url: '{% url "add_bom_item" %}',
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function() {
                alert('An error occurred while adding the component.');
            }
        });
    });
    
    // Edit item modal
    $(document).on('click', '.edit-item-btn', function() {
        const itemId = $(this).data('item-id');
        const row = $(`tr[data-item-id="${itemId}"]`);
        
        // Get the item details (in a real app, you'd fetch this from the server)
        const qty = row.find('td:nth-child(3)').text();
        const refDes = row.find('td:nth-child(4)').text();
        // Notes would typically come from a server request
        
        $('#editItemId').val(itemId);
        $('#editQuantity').val(qty);
        $('#editReferenceDesignators').val(refDes);
        $('#editItemModal').modal('show');
    });
    
    // Save edited item
    $('#confirmEditItem').click(function() {
        const form = $('#editItemForm');
        $.ajax({
            url: '{% url "update_bom_item" %}',
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function() {
                alert('An error occurred while updating the item.');
            }
        });
    });
    
    // Remove item
    $(document).on('click', '.remove-item-btn', function() {
        if (confirm('Are you sure you want to remove this component from the BOM?')) {
            const itemId = $(this).data('item-id');
            $.ajax({
                url: '{% url "remove_bom_item" %}',
                type: 'POST',
                data: {
                    'item_id': itemId,
                    'csrfmiddlewaretoken': '{{ csrf_token }}'
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while removing the item.');
                }
            });
        }
    });
    
    // Component selection in tree/list
    $(document).on('click', '.component-item, .component-row', function() {
        const componentId = $(this).data('component-id');
        const itemId = $(this).data('item-id');
        
        // Highlight selected item
        $('.component-item, .component-row').removeClass('active');
        $(this).addClass('active');
        
        // Load component details via AJAX
        $.get(`/api/components/${componentId}/`, function(data) {
            // Update properties panel
            $('#propertiesTitle').html(`<small>${data.part_number}</small>`);
            
            let suppliersHtml = '';
            if (data.suppliers.length > 0) {
                suppliersHtml = '<table class="table table-sm"><thead><tr><th>Supplier</th><th>Part No.</th><th>Cost</th><th>Lead Time</th></tr></thead><tbody>';
                data.suppliers.forEach(supplier => {
                    suppliersHtml += `
                        <tr>
                            <td>${supplier.supplier_name}</td>
                            <td>${supplier.supplier_part_number}</td>
                            <td>$${supplier.cost}</td>
                            <td>${supplier.lead_time_days} days</td>
                        </tr>
                    `;
                });
                suppliersHtml += '</tbody></table>';
            } else {
                suppliersHtml = '<div class="alert alert-warning">No supplier information available</div>';
            }
            
            let inventoryHtml = '';
            if (data.inventory.length > 0) {
                inventoryHtml = '<table class="table table-sm"><thead><tr><th>Location</th><th>On Hand</th><th>Allocated</th><th>Available</th></tr></thead><tbody>';
                data.inventory.forEach(inv => {
                    inventoryHtml += `
                        <tr>
                            <td>${inv.location_name}</td>
                            <td>${inv.quantity_on_hand}</td>
                            <td>${inv.quantity_allocated}</td>
                            <td>${inv.quantity_on_hand - inv.quantity_allocated}</td>
                        </tr>
                    `;
                });
                inventoryHtml += '</tbody></table>';
            } else {
                inventoryHtml = '<div class="alert alert-warning">No inventory information available</div>';
            }
            
            $('#propertiesPanel').html(`
                <div class="row">
                    <div class="col-md-4">
                        <div class="text-center mb-3">
                            ${data.thumbnail ? `<img src="${data.thumbnail}" class="img-fluid" alt="${data.part_number}">` : '<i class="bi bi-box-seam" style="font-size: 3rem;"></i>'}
                        </div>
                        <h5>${data.part_number}</h5>
                        <p>${data.description}</p>
                        <p><strong>Category:</strong> ${data.category_display}</p>
                        <p><strong>UOM:</strong> ${data.unit_of_measure}</p>
                    </div>
                    <div class="col-md-8">
                        <div class="mb-4">
                            <h6>Specifications</h6>
                            <table class="table table-sm">
                                <tr><th>Material</th><td>${data.material || '-'}</td></tr>
                                <tr><th>Tolerance</th><td>${data.tolerance || '-'}</td></tr>
                                <tr><th>Finish</th><td>${data.finish || '-'}</td></tr>
                                <tr><th>Weight</th><td>${data.weight ? data.weight + ' kg' : '-'}</td></tr>
                            </table>
                        </div>
                        
                        <div class="mb-4">
                            <h6>Suppliers</h6>
                            ${suppliersHtml}
                        </div>
                        
                        <div class="mb-4">
                            <h6>Inventory</h6>
                            ${inventoryHtml}
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-end">
                    <a href="/components/${componentId}/" class="btn btn-sm btn-outline-primary me-2">
                        <i class="bi bi-box-arrow-up-right"></i> View Details
                    </a>
                    <button class="btn btn-sm btn-outline-secondary edit-item-btn" data-item-id="${itemId}">
                        <i class="bi bi-pencil"></i> Edit Item
                    </button>
                </div>
            `);
        }).fail(function() {
            $('#propertiesPanel').html('<div class="alert alert-danger">Failed to load component details</div>');
        });
    });
    
    // Request approval
    $('#requestApprovalBtn').click(function() {
        $('#requestApprovalModal').modal('show');
    });
    
    $('#confirmRequestApproval').click(function() {
        const form = $('#approvalRequestForm');
        $.ajax({
            url: '{% url "request_bom_approval" %}',
            type: 'POST',
            data: form.serialize(),
            success: function(response) {
                if (response.success) {
                    location.reload();
                } else {
                    alert(response.message);
                }
            },
            error: function() {
                alert('An error occurred while submitting the approval request.');
            }
        });
    });
    
    // Initialize all components for search
    window.allComponents = JSON.parse('{{ all_components|escapejs }}');
});
</script>

<script src="{% static 'jquery/dist/jquery.min.js' %}"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>

{% if messages %}
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const theme = document.documentElement.getAttribute('data-bs-theme') || 'light';
      {% for message in messages %}
        Swal.fire({
          title: "{{ message.tags|title }}",
          text: "{{ message|escapejs }}",
          icon: "{{ message.tags }}", // valid: success, error, warning, info, question
          confirmButtonText: "OK",
          background: theme === 'dark' ? '#343a40' : '#ffffff',
          color: theme === 'dark' ? '#f8f9fa' : '#212529',
          confirmButtonColor: theme === 'dark' ? '#0d6efd' : '#0d6efd',
          customClass: {
            popup: 'rounded-4 shadow',
            confirmButton: 'btn btn-primary px-4 py-2'
          }
        });
      {% endfor %}
    });
  </script>
{% endif %}

{% endblock %}

{% block extra_javascript %}

{% include "bootstrap/partials/syntax-highlight.html" %}

<!-- Third party js -->
<script src="{% static 'js/vendor/handlebars.min.js' %}"></script>
<script src="{% static 'js/vendor/typeahead.bundle.min.js' %}"></script>
    <script src="{% static 'js/vendor/bootstrap-timepicker.min.js' %}"></script>
<!-- Third party js ends -->

<script src="{% static 'js/vendor/flatpickr.min.js' %}"></script>

<!-- Init js -->
<script src="{% static 'js/pages/demo.typehead.js' %}"></script>
<script src="{% static 'js/pages/demo.timepicker.js' %}"></script>
<!-- Init js end -->

<!-- Selectize.js JS -->
<script src="{% static 'js/selectize.min.js' %}"></script>

{% endblock %}